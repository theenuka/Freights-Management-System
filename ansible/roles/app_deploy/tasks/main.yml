---
- name: Login to AWS ECR
  community.docker.docker_login:
    registry_url: "{{ ecr_uri }}"
    username: AWS
    password: "{{ ecr_password }}"

- name: Create Docker Network
  community.docker.docker_network:
    name: freights-net
    state: present

- name: Determine admin image tag
  set_fact:
    admin_image_tag: "{{ commit_sha | default('latest') }}"

- name: Pull images
  community.docker.docker_image:
    name: "{{ item }}"
    source: pull
  loop:
    - "{{ ecr_uri }}/freights-management-app:latest"
    - "{{ ecr_uri }}/freights-management-frontend:latest"
    - "{{ ecr_uri }}/freights-management-admin:{{ admin_image_tag }}"
    - "{{ ecr_uri }}/freights-management-background:latest"

- name: Stop and remove old containers
  community.docker.docker_container:
    name: "{{ item }}"
    state: absent
  loop:
    - backend
    - frontend
    - admin
    - background

- name: Start Backend Container
  community.docker.docker_container:
    name: backend
    image: "{{ ecr_uri }}/freights-management-app:latest"
    state: started
    restart_policy: unless-stopped
    networks:
      - name: freights-net
    published_ports:
      - "8000:8000"
    env:
      DB: "{{ db_string }}"
      PORT: "8000"
      PASS: "{{ backend_pass }}"
      JWT_SEC: "{{ backend_jwt }}"

# Early diagnostics: ensure code is present and index.js loads before port wait
- name: Verify backend /app directory contents
  command: docker exec backend ls -1 /app
  register: backend_ls
  changed_when: false

- name: Show backend /app directory listing
  debug:
    var: backend_ls.stdout_lines

- name: Test requiring backend index.js (non-start import)
  command: docker exec backend node -e "try{const m=require('./index.js');console.log('INDEX_REQUIRE_OK',Object.keys(m));}catch(e){console.error('INDEX_REQUIRE_FAIL',e);process.exit(1)}"
  register: backend_index_require
  changed_when: false
  ignore_errors: true

- name: Show backend index.js require output
  debug:
    var: backend_index_require.stdout_lines

- name: Show backend index.js require stderr if any
  debug:
    var: backend_index_require.stderr_lines

- name: Backend runtime memory & node processes snapshot
  command: docker exec backend sh -c "(grep MemTotal /proc/meminfo || true); ps -o pid,comm,rss | grep node || true"
  register: backend_mem
  changed_when: false
  ignore_errors: true

- name: Show backend memory snapshot
  debug:
    var: backend_mem.stdout_lines

- name: Backend node version
  command: docker exec backend node -p "process.version"
  register: backend_node_version
  changed_when: false
  ignore_errors: true

- name: Show backend node version
  debug:
    var: backend_node_version.stdout_lines

- name: Start Frontend Container
  community.docker.docker_container:
    name: frontend
    image: "{{ ecr_uri }}/freights-management-frontend:latest"
    state: started
    restart_policy: unless-stopped
    networks:
      - name: freights-net
    published_ports:
      - "80:80"

- name: Start Admin Container
  community.docker.docker_container:
    name: admin
    image: "{{ ecr_uri }}/freights-management-admin:{{ admin_image_tag }}"
    state: started
    restart_policy: unless-stopped
    networks:
      - name: freights-net
    published_ports:
      - "3000:80"

- name: Start Background Container
  community.docker.docker_container:
    name: background
    image: "{{ ecr_uri }}/freights-management-background:latest"
    state: started
    restart_policy: unless-stopped
    networks:
      - name: freights-net
    env:
      DB: "{{ db_string }}"

# Sanity checks: ensure services are up
- name: Wait for Backend API to listen
  wait_for:
    host: 127.0.0.1
    port: 8000
    timeout: 60

- name: Wait for Admin to listen
  wait_for:
    host: 127.0.0.1
    port: 3000
    timeout: 60

- name: Pause briefly before backend health probe
  pause:
    seconds: 5

- block:
    - name: Probe Backend health endpoint (retry until healthy)
      uri:
        url: http://127.0.0.1:8000/api/v1/health
        status_code: 200
      register: backend_health
      retries: 6
      delay: 5
      until: backend_health.status == 200
  rescue:
    - name: Backend health probe failed - gather docker ps
      command: docker ps -a
      register: docker_ps
      changed_when: false
    - name: Show docker ps output
      debug:
        var: docker_ps.stdout_lines
    - name: Gather backend container inspect
      command: docker inspect backend
      register: backend_inspect
      changed_when: false
    - name: Show backend inspect
      debug:
        var: backend_inspect.stdout_lines
    - name: Fetch backend container logs
      command: docker logs --tail=200 backend
      register: backend_logs
      changed_when: false
    - name: Show backend logs
      debug:
        var: backend_logs.stdout_lines
    - name: Fail play explicitly after diagnostics
      fail:
        msg: "Backend health endpoint unreachable after retries. Diagnostics collected."

- name: Probe Admin root
  uri:
    url: http://127.0.0.1:3000
    return_content: no
    status_code: 200
