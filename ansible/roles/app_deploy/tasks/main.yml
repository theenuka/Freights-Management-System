---
# roles/app_deploy/tasks/main.yml
# Application deployment tasks using DockerHub

- name: Set image tag
  set_fact:
    deploy_tag: "{{ image_tag | default('latest') }}"
  tags: [deploy]

#------------------------------------------------------------------------------
# DockerHub Authentication
#------------------------------------------------------------------------------
- name: Login to DockerHub
  community.docker.docker_login:
    registry_url: https://index.docker.io/v1/
    username: "{{ dockerhub_username }}"
    password: "{{ vault_dockerhub_password }}"
  tags: [deploy, login]

#------------------------------------------------------------------------------
# Docker Network Setup
#------------------------------------------------------------------------------
- name: Create Docker network
  community.docker.docker_network:
    name: "{{ docker_network }}"
    state: present
  tags: [deploy, network]

#------------------------------------------------------------------------------
# Pull Images
#------------------------------------------------------------------------------
- name: Pull Docker images
  community.docker.docker_image:
    name: "{{ item.name }}:{{ item.tag }}"
    source: pull
    force_source: yes
  loop:
    - { name: "{{ images.backend }}", tag: "{{ deploy_tag }}" }
    - { name: "{{ images.frontend }}", tag: "{{ deploy_tag }}" }
    - { name: "{{ images.admin }}", tag: "{{ deploy_tag }}" }
    - { name: "{{ images.background }}", tag: "{{ deploy_tag }}" }
  loop_control:
    label: "{{ item.name }}:{{ item.tag }}"
  tags: [deploy, pull]

#------------------------------------------------------------------------------
# Stop Old Containers
#------------------------------------------------------------------------------
- name: Stop and remove old containers
  community.docker.docker_container:
    name: "{{ item }}"
    state: absent
  loop:
    - "{{ containers.backend }}"
    - "{{ containers.frontend }}"
    - "{{ containers.admin }}"
    - "{{ containers.background }}"
  tags: [deploy, cleanup]

#------------------------------------------------------------------------------
# Start Application Containers
#------------------------------------------------------------------------------
- name: Start Backend container
  community.docker.docker_container:
    name: "{{ containers.backend }}"
    image: "{{ images.backend }}:{{ deploy_tag }}"
    state: started
    restart_policy: unless-stopped
    networks:
      - name: "{{ docker_network }}"
    published_ports:
      - "{{ ports.backend }}:8000"
    env:
      DB: "{{ vault_db_string }}"
      PORT: "{{ backend_port }}"
      PASS: "{{ vault_backend_pass }}"
      JWT_SEC: "{{ vault_backend_jwt }}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
  tags: [deploy, backend]

- name: Start Frontend container
  community.docker.docker_container:
    name: "{{ containers.frontend }}"
    image: "{{ images.frontend }}:{{ deploy_tag }}"
    state: started
    restart_policy: unless-stopped
    networks:
      - name: "{{ docker_network }}"
    published_ports:
      - "{{ ports.frontend }}:80"
  tags: [deploy, frontend]

- name: Start Admin container
  community.docker.docker_container:
    name: "{{ containers.admin }}"
    image: "{{ images.admin }}:{{ deploy_tag }}"
    state: started
    restart_policy: unless-stopped
    networks:
      - name: "{{ docker_network }}"
    published_ports:
      - "{{ ports.admin }}:80"
  tags: [deploy, admin]

- name: Start Background service container
  community.docker.docker_container:
    name: "{{ containers.background }}"
    image: "{{ images.background }}:{{ deploy_tag }}"
    state: started
    restart_policy: unless-stopped
    networks:
      - name: "{{ docker_network }}"
    env:
      DB: "{{ vault_db_string }}"
      EMAIL_USER: "{{ vault_email_user | default('') }}"
      EMAIL_PASS: "{{ vault_email_pass | default('') }}"
  tags: [deploy, background]

#------------------------------------------------------------------------------
# Health Checks
#------------------------------------------------------------------------------
- name: Wait for Backend to be ready
  wait_for:
    host: 127.0.0.1
    port: "{{ ports.backend }}"
    timeout: "{{ health_check.timeout }}"
  tags: [deploy, health]

- name: Wait for Frontend to be ready
  wait_for:
    host: 127.0.0.1
    port: "{{ ports.frontend }}"
    timeout: "{{ health_check.timeout }}"
  tags: [deploy, health]

- name: Wait for Admin to be ready
  wait_for:
    host: 127.0.0.1
    port: "{{ ports.admin }}"
    timeout: "{{ health_check.timeout }}"
  tags: [deploy, health]

- name: Verify Backend health endpoint
  uri:
    url: "{{ health_check.backend_endpoint }}"
    status_code: 200
  register: backend_health
  retries: "{{ health_check.retries }}"
  delay: "{{ health_check.delay }}"
  until: backend_health.status == 200
  tags: [deploy, health]

- name: Show running containers
  command: docker ps --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}\t{{ '{{' }}.Ports{{ '}}' }}"
  register: docker_ps
  changed_when: false
  tags: [deploy, verify]

- name: Display container status
  debug:
    var: docker_ps.stdout_lines
  tags: [deploy, verify]

#------------------------------------------------------------------------------
# Cleanup
#------------------------------------------------------------------------------
- name: Logout from DockerHub
  community.docker.docker_login:
    state: absent
  tags: [deploy, cleanup]

- name: Prune unused Docker images
  community.docker.docker_prune:
    images: yes
    images_filters:
      dangling: true
  tags: [deploy, cleanup]
