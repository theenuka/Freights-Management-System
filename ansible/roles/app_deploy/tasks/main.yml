---
# roles/app_deploy/tasks/main.yml
# Application deployment using Docker Compose

- name: Set image tag
  set_fact:
    deploy_tag: "{{ image_tag | default('latest') }}"
  tags: [deploy]

#------------------------------------------------------------------------------
# Ensure app directory exists
#------------------------------------------------------------------------------
- name: Create application directory
  file:
    path: "{{ app_dir }}"
    state: directory
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0755'
  tags: [deploy, setup]

#------------------------------------------------------------------------------
# Deploy docker-compose file
#------------------------------------------------------------------------------
- name: Deploy docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: "{{ app_dir }}/docker-compose.yml"
    owner: "{{ app_user }}"
    group: "{{ app_group }}"
    mode: '0644'
  tags: [deploy]

#------------------------------------------------------------------------------
# DockerHub Authentication (for private repos)
#------------------------------------------------------------------------------
- name: Login to DockerHub
  community.docker.docker_login:
    registry_url: https://index.docker.io/v1/
    username: "{{ dockerhub_username }}"
    password: "{{ vault_dockerhub_password }}"
  tags: [deploy, login]

#------------------------------------------------------------------------------
# Pull and Deploy
#------------------------------------------------------------------------------
- name: Pull latest images
  command: docker compose pull
  args:
    chdir: "{{ app_dir }}"
  tags: [deploy, pull]

- name: Start application with docker compose
  command: docker compose up -d
  args:
    chdir: "{{ app_dir }}"
  tags: [deploy, start]

#------------------------------------------------------------------------------
# Health Checks
#------------------------------------------------------------------------------
- name: Wait for Backend to be ready
  wait_for:
    host: 127.0.0.1
    port: "{{ ports.backend }}"
    timeout: "{{ health_check.timeout }}"
  tags: [deploy, health]

- name: Wait for Frontend to be ready
  wait_for:
    host: 127.0.0.1
    port: "{{ ports.frontend }}"
    timeout: "{{ health_check.timeout }}"
  tags: [deploy, health]

- name: Wait for Admin to be ready
  wait_for:
    host: 127.0.0.1
    port: "{{ ports.admin }}"
    timeout: "{{ health_check.timeout }}"
  tags: [deploy, health]

- name: Verify Backend health endpoint
  uri:
    url: "{{ health_check.backend_endpoint }}"
    status_code: 200
  register: backend_health
  retries: "{{ health_check.retries }}"
  delay: "{{ health_check.delay }}"
  until: backend_health.status == 200
  tags: [deploy, health]

- name: Show running containers
  command: docker ps --format "table {{'{{'}}.Names{{'}}'}}\t{{'{{'}}.Status{{'}}'}}\t{{'{{'}}.Ports{{'}}'}}"
  register: docker_ps
  changed_when: false
  tags: [deploy, verify]

- name: Display container status
  debug:
    var: docker_ps.stdout_lines
  tags: [deploy, verify]

#------------------------------------------------------------------------------
# Cleanup
#------------------------------------------------------------------------------
- name: Logout from DockerHub
  community.docker.docker_login:
    state: absent
  tags: [deploy, cleanup]

- name: Prune unused Docker images
  command: docker image prune -f
  changed_when: false
  tags: [deploy, cleanup]
