<UserControl x:Class="FreightsManagementWPF.Views.ParcelsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes">
    
    <UserControl.Resources>
        <Style x:Key="FormTextBox" TargetType="TextBox" BasedOn="{StaticResource MaterialDesignOutlinedTextBox}">
            <Setter Property="Margin" Value="0,4"/>
            <Setter Property="Height" Value="48"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="2*"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Parcels List -->
        <materialDesign:Card Grid.Row="0" Margin="0,0,0,8">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <Grid Grid.Row="0" Margin="16,16,16,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBlock Grid.Column="0" Text="Parcels Management" FontSize="24" FontWeight="Bold" VerticalAlignment="Center"/>
                    
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Style="{StaticResource MaterialDesignIconButton}"
                              Command="{Binding LoadParcelsCommand}"
                              ToolTip="Refresh">
                            <materialDesign:PackIcon Kind="Refresh"/>
                        </Button>
                        <Button Style="{StaticResource MaterialDesignRaisedButton}"
                              Content="Add Parcel"
                              Command="{Binding AddParcelCommand}"
                              Margin="8,0,0,0"/>
                    </StackPanel>
                </Grid>

                <!-- Parcels DataGrid -->
                <DataGrid Grid.Row="1" 
                        ItemsSource="{Binding Parcels}"
                        SelectedItem="{Binding SelectedParcel}"
                        AutoGenerateColumns="False"
                        CanUserAddRows="False"
                        CanUserDeleteRows="False"
                        IsReadOnly="True"
                        Margin="16,0">
                    
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Tracking #" Binding="{Binding TrackingNumber}" Width="120"/>
                        <DataGridTextColumn Header="Sender" Binding="{Binding SenderName}" Width="120"/>
                        <DataGridTextColumn Header="Receiver" Binding="{Binding ReceiverName}" Width="120"/>
                        <DataGridTextColumn Header="Weight (kg)" Binding="{Binding Weight}" Width="80"/>
                        <DataGridTextColumn Header="Status" Binding="{Binding StatusDisplay}" Width="100"/>
                        <DataGridTextColumn Header="Created" Binding="{Binding CreatedDate, StringFormat=yyyy-MM-dd}" Width="100"/>
                        <DataGridTextColumn Header="User" Binding="{Binding User.FullName}" Width="120" 
                                          Visibility="{Binding DataContext.IsAdmin, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </DataGrid.Columns>
                    
                </DataGrid>

                <!-- Actions -->
                <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="16">
                    <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                          Content="Edit"
                          Command="{Binding EditParcelCommand}"
                          Margin="4"/>
                    <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                          Content="Delete"
                          Command="{Binding DeleteParcelCommand}"
                          Margin="4"/>
                    
                    <!-- Status Update Menu -->
                    <materialDesign:PopupBox PlacementMode="TopAndAlignRightEdges" Margin="4">
                        <materialDesign:PopupBox.ToggleContent>
                            <Button Style="{StaticResource MaterialDesignIconButton}"
                                  ToolTip="Update Status">
                                <materialDesign:PackIcon Kind="DotsVertical"/>
                            </Button>
                        </materialDesign:PopupBox.ToggleContent>
                        <StackPanel>
                            <Button Content="Set Pending" 
                                  Command="{Binding UpdateStatusCommand}" 
                                  CommandParameter="Pending"/>
                            <Button Content="Set In Transit" 
                                  Command="{Binding UpdateStatusCommand}" 
                                  CommandParameter="InTransit"/>
                            <Button Content="Set Delivered" 
                                  Command="{Binding UpdateStatusCommand}" 
                                  CommandParameter="Delivered"/>
                            <Button Content="Set Cancelled" 
                                  Command="{Binding UpdateStatusCommand}" 
                                  CommandParameter="Cancelled"/>
                        </StackPanel>
                    </materialDesign:PopupBox>
                </StackPanel>

            </Grid>
        </materialDesign:Card>

        <!-- Parcel Form -->
        <materialDesign:Card Grid.Row="1" Margin="0,8,0,0">
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <Grid Margin="16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Column 1: Basic Info -->
                    <StackPanel Grid.Column="0" Margin="0,0,8,0">
                        <TextBlock Text="{Binding IsEditMode, Converter={StaticResource BooleanToStringConverter}, ConverterParameter='Edit Parcel|Add New Parcel'}" 
                                 FontSize="20" FontWeight="Bold" Margin="0,0,0,16"/>

                        <!-- Error Message -->
                        <TextBlock Text="{Binding ErrorMessage}" 
                                 Foreground="Red" 
                                 TextWrapping="Wrap"
                                 Margin="0,0,0,8"
                                 Visibility="{Binding ErrorMessage, Converter={StaticResource StringToVisibilityConverter}}"/>

                        <!-- Tracking Number -->
                        <TextBox Style="{StaticResource FormTextBox}"
                               materialDesign:HintAssist.Hint="Tracking Number (auto-generated if empty)"
                               materialDesign:HintAssist.IsFloating="True"
                               Text="{Binding TrackingNumber, UpdateSourceTrigger=PropertyChanged}"/>

                        <!-- Weight -->
                        <TextBox Style="{StaticResource FormTextBox}"
                               materialDesign:HintAssist.Hint="Weight (kg)"
                               materialDesign:HintAssist.IsFloating="True"
                               Text="{Binding Weight, UpdateSourceTrigger=PropertyChanged}"/>

                        <!-- Dimensions -->
                        <TextBox Style="{StaticResource FormTextBox}"
                               materialDesign:HintAssist.Hint="Dimensions (e.g., 10x8x6 inches)"
                               materialDesign:HintAssist.IsFloating="True"
                               Text="{Binding Dimensions, UpdateSourceTrigger=PropertyChanged}"/>

                        <!-- Status -->
                        <ComboBox Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                materialDesign:HintAssist.Hint="Status"
                                materialDesign:HintAssist.IsFloating="True"
                                ItemsSource="{Binding StatusOptions}"
                                SelectedValue="{Binding Status}"
                                Margin="0,4"
                                Height="48"/>

                    </StackPanel>

                    <!-- Column 2: Sender Info -->
                    <StackPanel Grid.Column="1" Margin="8,0">
                        <TextBlock Text="Sender Information" FontSize="16" FontWeight="Bold" Margin="0,16,0,8"/>

                        <!-- Sender Name -->
                        <TextBox Style="{StaticResource FormTextBox}"
                               materialDesign:HintAssist.Hint="Sender Name"
                               materialDesign:HintAssist.IsFloating="True"
                               Text="{Binding SenderName, UpdateSourceTrigger=PropertyChanged}"/>

                        <!-- Sender Address -->
                        <TextBox Style="{StaticResource FormTextBox}"
                               materialDesign:HintAssist.Hint="Sender Address"
                               materialDesign:HintAssist.IsFloating="True"
                               Text="{Binding SenderAddress, UpdateSourceTrigger=PropertyChanged}"
                               TextWrapping="Wrap"
                               AcceptsReturn="True"
                               Height="80"/>

                        <!-- Sender Phone -->
                        <TextBox Style="{StaticResource FormTextBox}"
                               materialDesign:HintAssist.Hint="Sender Phone"
                               materialDesign:HintAssist.IsFloating="True"
                               Text="{Binding SenderPhone, UpdateSourceTrigger=PropertyChanged}"/>

                    </StackPanel>

                    <!-- Column 3: Receiver Info -->
                    <StackPanel Grid.Column="2" Margin="8,0,0,0">
                        <TextBlock Text="Receiver Information" FontSize="16" FontWeight="Bold" Margin="0,16,0,8"/>

                        <!-- Receiver Name -->
                        <TextBox Style="{StaticResource FormTextBox}"
                               materialDesign:HintAssist.Hint="Receiver Name"
                               materialDesign:HintAssist.IsFloating="True"
                               Text="{Binding ReceiverName, UpdateSourceTrigger=PropertyChanged}"/>

                        <!-- Receiver Address -->
                        <TextBox Style="{StaticResource FormTextBox}"
                               materialDesign:HintAssist.Hint="Receiver Address"
                               materialDesign:HintAssist.IsFloating="True"
                               Text="{Binding ReceiverAddress, UpdateSourceTrigger=PropertyChanged}"
                               TextWrapping="Wrap"
                               AcceptsReturn="True"
                               Height="80"/>

                        <!-- Receiver Phone -->
                        <TextBox Style="{StaticResource FormTextBox}"
                               materialDesign:HintAssist.Hint="Receiver Phone"
                               materialDesign:HintAssist.IsFloating="True"
                               Text="{Binding ReceiverPhone, UpdateSourceTrigger=PropertyChanged}"/>

                        <!-- User Assignment (Admin only) -->
                        <ComboBox Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                materialDesign:HintAssist.Hint="Assigned User"
                                materialDesign:HintAssist.IsFloating="True"
                                ItemsSource="{Binding Users}"
                                SelectedValue="{Binding SelectedUserId}"
                                SelectedValuePath="Id"
                                DisplayMemberPath="FullName"
                                Visibility="{Binding IsAdmin, Converter={StaticResource BooleanToVisibilityConverter}}"
                                Margin="0,4"
                                Height="48"/>

                        <!-- Action Buttons -->
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,16,0,0">
                            <Button Style="{StaticResource MaterialDesignOutlinedButton}"
                                  Content="Cancel"
                                  Command="{Binding CancelEditCommand}"
                                  Margin="0,0,8,0"/>
                            <Button Style="{StaticResource MaterialDesignRaisedButton}"
                                  Content="{Binding IsEditMode, Converter={StaticResource BooleanToStringConverter}, ConverterParameter='Update|Create'}"
                                  Command="{Binding SaveParcelCommand}"
                                  IsEnabled="{Binding CanSaveParcel}">
                                
                                <Button.Content>
                                    <Grid>
                                        <TextBlock Text="{Binding IsEditMode, Converter={StaticResource BooleanToStringConverter}, ConverterParameter='Update|Create'}" 
                                                 Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Inverted}"/>
                                        <StackPanel Orientation="Horizontal" 
                                                  Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}"
                                                       Width="16" Height="16"
                                                       IsIndeterminate="True"
                                                       Foreground="White"/>
                                            <TextBlock Text="Saving..." Margin="8,0,0,0"/>
                                        </StackPanel>
                                    </Grid>
                                </Button.Content>
                            </Button>
                        </StackPanel>

                    </StackPanel>

                </Grid>
            </ScrollViewer>
        </materialDesign:Card>

    </Grid>
</UserControl>